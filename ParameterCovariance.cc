#include "ParameterCovariance.h"

#include <iostream>
#include <iomanip>

namespace utl {

  using namespace std;

  // calculat V = L * L^T
  vector<std::vector<double>>
  VfromL(const std::vector<double>& L) {

    const unsigned int n = (sqrt(1+8*L.size()) - 1) / 2;
    vector<vector<double>> V(n, vector<double>(n, 0.));

    auto index = [](unsigned int i, unsigned int j) {
       return (i * (i + 1)) / 2 + j;
    };

    for (unsigned int i = 0; i < n; ++i) {
      for (unsigned int j = 0; j <= i; ++j) {
        double sum = 0;
        for (unsigned int k = 0; k <= std::min(i, j); ++k)
          sum += L[index(i, k)] * L[index(j, k)];
        V[i][j] = sum;
        if (i != j)
          V[j][i] = sum;
      }
    }
    return V;
  }
}

ParameterCovariance::ParameterCovariance(const UF23Field::ModelType mt) :
  fModelType(mt)
{

  using mf = UF23Field;

  switch (fModelType) {
  case mf::base: {
    fL = {
           1.39562e-01, -6.54085e-02,  1.96911e-01,  2.66170e-03,  7.39673e-02,
           1.31233e-01,  4.38627e+00, -5.73125e+00,  3.96343e-01,  4.48478e+00,
          -2.76039e-01, -8.39084e-01, -1.27464e+00,  2.03763e+00,  1.13046e+00,
           6.70593e-01,  1.35176e-01, -3.82145e-01,  1.77802e+00,  8.54741e-01,
           4.89239e-01,  5.32912e-02, -2.53639e-02, -8.78323e-05,  9.60822e-02,
           5.59280e-02,  1.99711e-02,  1.99797e-02,  8.09574e-02, -5.22914e-02,
           1.04681e-01,  4.01155e-02,  1.24853e-02, -1.57598e-02,  3.80346e-02,
           2.73338e-01, -6.09083e-02,  5.35443e-02, -1.02965e-01, -4.51922e-02,
           5.21954e-03,  5.73934e-03, -4.37831e-02, -2.50744e-01,  5.74450e-02,
           4.31914e-03,  1.09432e-02,  1.91788e-02,  3.00872e-02, -1.02555e-02,
          -8.85333e-03,  3.31359e-02, -7.99971e-03,  3.82178e-04,  1.63701e-01,
           2.51630e-02,  2.73540e-02,  7.49086e-02,  5.13695e-02,  1.03048e-02,
          -1.91850e-02,  4.37730e-02,  5.99822e-02,  2.77696e-03,  1.79149e-01,
           3.36912e-01, -5.43659e-02,  6.73414e-02, -2.52585e-01, -1.28087e-01,
           9.72050e-03,  4.55441e-02, -1.02084e-01, -5.26943e-01,  8.65182e-02,
           1.38017e-02,  2.19318e-01,  2.34028e-01,  7.30502e-03, -5.96256e-03,
          -2.77896e-03, -1.96214e-03, -1.29403e-03,  3.57595e-03, -1.57752e-03,
           1.16935e-02, -3.15322e-03,  5.50079e-03,  2.58879e-03,  1.28416e-02,
           2.51867e-02, -7.80606e-04, -6.08968e-04, -3.31634e-03, -1.00560e-03,
          -1.90903e-03,  5.22164e-04,  2.15408e-03,  3.40526e-03,  6.10413e-03,
           5.25004e-03, -3.04494e-03, -1.19098e-03, -3.57288e-02,  8.42481e-02,
          -4.72065e-03,  4.26466e-03, -4.48180e-03,  1.10559e-03, -3.83847e-03,
          -7.47686e-05,  3.33721e-03, -2.21504e-03, -1.66635e-03, -2.13078e-03,
          -1.00434e-03, -9.41848e-03, -2.72426e-02,  2.75402e-02,  3.91601e-02,
          -1.38041e-03,  1.49083e-03, -7.93107e-05,  1.25911e-04, -4.67348e-04,
          -9.21439e-04,  9.43735e-04, -2.52732e-03,  1.10854e-03,  2.83980e-04,
          -1.17611e-05, -2.39549e-03,  9.44256e-03,  2.97175e-03,  2.94127e-03,
           2.62734e-02,  3.00997e-03,  9.66463e-03, -2.27886e-03,  2.20331e-03,
           4.40898e-03,  2.65953e-04, -9.37628e-03, -2.45932e-02, -2.22911e-02,
          -2.93409e-02,  2.67895e-02,  9.63532e-03,  1.64344e-01, -3.39396e-01,
           8.55500e-02,  7.72724e-03,  9.92386e-02,  1.19129e-02, -6.56950e-03,
           9.83770e-03,  4.00257e-03,  9.26317e-04, -1.47288e-03,  5.54780e-03,
           1.98617e-02,  7.23500e-04,  1.89532e-03, -1.19248e-03,  1.27725e-02,
          -2.40595e-03, -2.43196e-03, -1.39745e-03,  1.28483e-03,  1.70057e-03,
           1.14572e-02,  8.04304e-03, -4.29058e-03,  1.63228e-03, -7.40672e-04,
           1.03992e-03,  1.84515e-03,  2.39947e-03,  7.22288e-03,  4.45706e-03,
          -1.99596e-03, -9.43494e-04,  6.35893e-03, -6.28036e-03, -3.77930e-03,
          -2.35889e-03,  2.89818e-03,  3.10305e-03,  8.84379e-03,  1.67461e-02,
          -1.03959e-02,  8.63190e-03,  5.41233e-03,  3.96455e-03,  1.28257e-03,
          -4.17208e-03,  1.65391e-03, -1.58028e-02,  3.41188e-03, -8.83596e-03,
          -1.81508e-03, -1.79711e-02, -6.11229e-03, -3.02850e-03, -1.75780e-03,
           3.12418e-03,  3.24976e-03,  5.01505e-03,  4.19117e-03,  9.90420e-03
    };
    fIndices = {mf::eDiskB1, mf::eDiskB2, mf::eDiskB3, mf::eDiskPhase1,
                mf::eDiskPhase2, mf::eDiskPhase3, mf::eDiskPitch,
                mf::eToroidalBN, mf::eToroidalBS, mf::eToroidalR,
                mf::eToroidalR, mf::eToroidalZ, mf::ePoloidalB, mf::ePoloidalP,
                mf::ePoloidalR, mf::ePoloidalW, mf::ePoloidalZ, mf::eDiskH,
                mf::eDiskW, mf::eStriation};
    break;
  }
  case mf::neCL: {
    fL = {
           2.60831e-01, -3.94427e-01,  2.00018e-01,  1.56671e-01, -1.89801e-01,
           2.28642e-01, -6.00905e+00, -4.93742e+00,  2.47172e+00,  7.40533e+00,
          -2.24675e+00,  5.55652e+00, -7.97970e+00, -1.73250e+00,  5.52733e+00,
          -1.72289e+00,  5.33119e-01, -2.22885e+00,  7.11129e-01,  3.08850e+00,
           1.08249e+00, -2.13617e-01,  7.54893e-02, -1.14538e-01,  8.94928e-02,
           2.50433e-01,  9.13978e-02,  4.52126e-02, -2.96267e-02, -2.40466e-02,
           2.73476e-02,  1.48175e-02,  4.22510e-02,  7.42279e-04,  3.63392e-02,
           1.51615e-01,  3.24231e-02,  2.80754e-02, -2.38991e-02, -1.73391e-03,
          -3.63889e-02, -1.50270e-02, -4.77441e-02, -1.44991e-01,  4.36895e-02,
          -2.09339e-02, -1.22781e-02, -8.54471e-03,  6.20573e-03,  1.49184e-02,
           1.28979e-02,  5.69264e-02, -2.03001e-02,  4.18531e-03,  1.84501e-01,
          -2.19951e-02, -1.31560e-02, -8.27399e-04,  1.20418e-02,  3.17145e-02,
           7.05339e-04,  4.88320e-02, -9.43454e-03,  9.53902e-03,  2.19834e-01,
           1.77705e-01,  1.05496e-01,  1.37548e-01, -1.15592e-01,  6.01470e-02,
          -2.34731e-01, -6.98011e-03, -2.21007e-01, -6.23635e-01,  1.24599e-01,
           9.21921e-02,  1.90246e-01,  2.55189e-01, -1.85355e-03, -3.43857e-05,
          -4.17032e-03,  4.12241e-03, -6.24663e-03,  6.21835e-03, -3.50720e-03,
           4.08860e-03, -1.31715e-03,  6.51173e-03,  1.31092e-03,  1.28388e-02,
           2.51692e-02, -8.26352e-04, -1.64738e-04,  8.67816e-03, -2.83757e-03,
           6.38503e-03, -1.11287e-03, -3.50864e-03,  1.06310e-02,  9.94281e-03,
          -5.33248e-04, -1.08549e-02, -3.05533e-03, -2.42714e-02,  1.01024e-01,
           5.48621e-04,  7.37666e-04,  1.13622e-03, -2.61750e-03, -4.24310e-05,
          -2.29306e-03,  5.48398e-03,  5.12608e-03, -3.30619e-03, -1.81156e-03,
          -1.48680e-03, -8.78286e-03, -2.72825e-02,  1.47635e-02,  3.40785e-02,
           6.96960e-04, -7.26144e-04,  7.67717e-04, -7.44999e-04,  1.45327e-03,
          -5.11206e-04, -8.00095e-04, -2.35927e-03,  2.51040e-03, -2.46005e-04,
          -7.14548e-04, -2.49836e-04,  1.42222e-02,  5.71295e-03, -5.41969e-03,
           2.46029e-02,  2.99320e-03,  4.50956e-04, -3.02082e-02,  8.82479e-03,
          -1.91740e-02,  4.69892e-03,  4.23202e-03, -3.66879e-02, -1.94725e-02,
           1.41691e-04,  3.91215e-02,  1.54957e-02,  7.80152e-02, -2.45450e-01,
           4.34104e-02,  8.52543e-03,  7.49400e-02, -4.27314e-03, -3.71503e-03,
           2.43419e-03,  3.34463e-03,  3.92987e-03,  9.38672e-04,  5.63160e-03,
           9.42450e-03,  7.92443e-05,  4.64808e-04, -4.09207e-05,  7.87982e-03,
          -1.14426e-03, -1.35497e-03, -1.11514e-03,  3.06098e-04,  1.14096e-03,
           8.81478e-03, -1.64248e-03,  4.64355e-04,  1.18115e-04,  3.90966e-03,
          -1.24963e-03,  8.30692e-05,  8.06975e-05,  3.45545e-03,  2.94839e-03,
           1.47379e-03,  6.99387e-04,  1.89821e-03, -5.90475e-03, -2.45411e-03,
          -2.17253e-03,  2.22985e-03,  3.10779e-03,  5.02780e-03,  1.58314e-02,
           2.51770e-03, -2.92162e-03,  3.00063e-03, -7.12674e-03,  1.00147e-02,
          -6.21068e-03,  4.26007e-03, -6.72208e-03,  2.07134e-03, -1.06263e-02,
          -3.08113e-04, -1.71441e-02, -4.94083e-03, -9.49693e-04, -2.68103e-03,
           3.03554e-03,  3.67395e-03,  2.62865e-03,  4.39360e-03,  9.52844e-03
          };
    fIndices = {mf::eDiskB1, mf::eDiskB2, mf::eDiskB3, mf::eDiskPhase1,
                mf::eDiskPhase2, mf::eDiskPhase3, mf::eDiskPitch,
                mf::eToroidalBN, mf::eToroidalBS, mf::eToroidalR,
                mf::eToroidalR, mf::eToroidalZ, mf::ePoloidalB, mf::ePoloidalP,
                mf::ePoloidalR, mf::ePoloidalW, mf::ePoloidalZ, mf::eDiskH,
                mf::eDiskW, mf::eStriation,};
    break;
  }
  case mf::spur: {
    fL = {
           1.78487e-01,  1.65471e-01,  2.96390e+00,  3.73361e-01, -2.88580e+00,
           8.41152e-01, -2.59328e-01,  1.62191e-01, -2.83355e-01,  1.33412e+00,
          -8.95536e-02,  6.40966e-02, -1.57480e-01,  5.15988e-01,  2.40346e-01,
           2.17085e-01, -7.27981e-02, -4.19336e-02, -5.12722e-01, -1.01308e-01,
           1.90617e-01,  3.45097e-02, -8.97274e-03, -1.19875e-02, -2.69807e-02,
           6.20583e-02, -5.80798e-02,  2.10840e-01, -3.45241e-02,  7.42706e-03,
           8.87177e-03,  2.49334e-02, -5.88129e-02,  6.21186e-02, -1.80732e-01,
           4.63153e-02,  1.46593e-02, -3.19495e-03, -1.40752e-02, -1.46638e-02,
           2.37059e-02, -6.71885e-03, -1.92462e-02,  4.74872e-03,  1.20075e-01,
           2.28650e-02, -8.95110e-03, -3.40939e-02, -3.39778e-02,  3.85089e-02,
           5.40695e-03,  2.49064e-02,  2.56841e-03,  1.05044e-01,  2.72046e-01,
          -4.31555e-01,  5.65943e-02,  1.76929e-01,  1.86104e-01, -3.97870e-01,
           3.99315e-01, -1.03934e+00,  1.43703e-01, -1.51186e-02,  4.28679e-01,
           4.71534e-01, -8.30797e-03,  7.44603e-04,  5.14032e-03,  2.86610e-03,
          -1.83103e-03, -2.17324e-04,  1.18347e-02, -3.27406e-03,  4.82021e-03,
           2.79808e-03,  1.56693e-02,  2.89347e-02, -2.58014e-03,  5.54023e-04,
           1.27501e-03, -3.21825e-04, -1.36310e-03,  1.82934e-03,  1.47477e-03,
           6.28870e-03,  5.24223e-03, -2.45298e-03,  7.21016e-04, -3.84446e-02,
           8.54982e-02,  1.93759e-03,  1.00610e-06, -9.77942e-04, -8.52646e-04,
          -6.43544e-05, -6.79856e-05, -1.51912e-03, -1.62995e-04, -2.14736e-03,
          -8.07648e-04, -9.55776e-03, -3.74682e-02,  2.63233e-02,  4.15515e-02,
           1.99780e-03,  1.97502e-05, -4.85238e-04, -1.10138e-03,  4.21117e-04,
          -4.69690e-04, -2.18131e-03,  1.30811e-03,  7.22410e-04,  6.48912e-04,
          -4.79491e-04,  1.64138e-02,  2.93173e-03, -1.20921e-03,  2.97020e-02,
           5.65427e-03, -1.14687e-03, -4.79535e-03,  5.11207e-03, -5.16475e-04,
          -9.58427e-04, -1.21121e-02, -2.29823e-02, -3.07329e-02,  2.64404e-02,
           5.28916e-03,  1.76779e-01, -3.52133e-01,  9.25891e-02,  1.93692e-02,
           1.06960e-01,  2.26674e-03, -1.20340e-03,  5.50165e-04, -3.99839e-03,
           8.52268e-03, -8.41347e-03,  1.79664e-02,  1.02979e-04,  1.98385e-03,
          -1.32549e-03,  1.09986e-02, -1.54760e-03, -2.01545e-03, -1.64851e-03,
           1.00834e-03,  1.39875e-03,  1.10933e-02, -6.95962e-03, -7.95822e-04,
           2.81788e-03, -1.98992e-03,  3.05077e-03, -5.47640e-04,  5.28058e-03,
           4.11364e-03, -1.43809e-03,  1.38149e-04,  2.46925e-03, -5.57104e-03,
          -3.57269e-03, -3.03395e-03,  2.35825e-03,  3.09312e-03,  1.08912e-02,
           1.58566e-02,  1.25377e-02, -1.05369e-03, -7.50948e-03, -3.90399e-03,
           2.83190e-03, -2.03508e-04, -1.51979e-02,  3.26876e-03, -7.41358e-03,
          -1.58313e-03, -1.93573e-02, -5.44607e-03, -2.54862e-03, -2.68621e-03,
           3.13305e-03,  3.09936e-03,  4.05692e-03,  5.05076e-03,  9.91406e-03
          };
    fIndices = {mf::eDiskB1, mf::eSpurCenter, mf::eSpurLength,
                mf::eDiskPhase1, mf::eDiskPitch, mf::eSpurWidth,
                mf::eToroidalBN, mf::eToroidalBS, mf::eToroidalR,
                mf::eToroidalR, mf::eToroidalZ, mf::ePoloidalB,
                mf::ePoloidalP, mf::ePoloidalR, mf::ePoloidalW,
                mf::ePoloidalZ, mf::eDiskH, mf::eDiskW, mf::eStriation};
    break;
  }
  case mf::cre10: {
   fL = {
           1.37551e-01,  7.05676e-02,  2.00617e-01,  5.41195e-03,  7.10812e-02,
           1.36857e-01, -3.76086e+00, -5.03473e+00,  3.45005e-01,  4.32960e+00,
           2.18075e-01, -7.36663e-01, -1.26842e+00,  2.09765e+00,  1.06916e+00,
          -5.92677e-01,  2.10352e-01, -3.90999e-01,  1.80386e+00,  8.15178e-01,
           4.69599e-01, -4.80847e-02, -2.02888e-02,  6.40280e-06,  9.99839e-02,
           5.37202e-02,  1.89159e-02,  1.92030e-02, -8.20691e-02, -6.19705e-02,
           1.36366e-01,  6.45989e-02,  1.40261e-02, -2.52397e-02,  5.46677e-02,
           3.13438e-01,  6.00214e-02,  6.26335e-02, -1.32275e-01, -6.89765e-02,
           6.15319e-03,  1.40717e-02, -5.97975e-02, -2.84923e-01,  6.33595e-02,
          -1.45854e-03,  1.27917e-02,  2.99539e-02,  3.80335e-02, -1.06518e-02,
          -1.49556e-02,  3.81201e-02, -4.01237e-03, -1.04880e-03,  1.87600e-01,
          -1.87963e-02,  2.91930e-02,  8.71979e-02,  6.30809e-02,  1.45075e-02,
          -2.30043e-02,  4.53524e-02,  6.97260e-02,  1.86017e-03,  2.19142e-01,
           3.38571e-01,  1.97097e-02,  3.51671e-02, -1.46389e-01, -8.12848e-02,
           6.94844e-03,  2.89020e-02, -6.05404e-02, -2.71016e-01,  4.14517e-02,
           1.77821e-02,  1.03790e-01,  1.23052e-01, -7.74537e-03, -6.79054e-03,
          -1.71887e-03, -9.56661e-04, -7.58968e-04,  2.53036e-03, -4.67279e-04,
           1.35276e-02, -3.79347e-03,  6.18988e-03,  1.68707e-03,  1.29306e-02,
           2.48066e-02,  2.04329e-03,  7.22125e-04, -1.58841e-03,  1.03468e-04,
          -2.96617e-03, -1.89076e-04,  3.36643e-03,  4.09945e-03,  5.44867e-03,
           3.44544e-03, -5.36243e-03, -4.20734e-03, -3.85482e-02,  8.30482e-02,
           5.59326e-03,  5.39990e-03, -4.46061e-03,  1.16507e-03, -5.19508e-03,
           4.29349e-04,  3.75735e-03, -2.97647e-03, -1.47728e-03, -3.41935e-03,
          -8.30188e-04, -1.09772e-02, -3.14652e-02,  2.95677e-02,  4.10630e-02,
           9.46123e-04,  1.20603e-03, -3.88904e-05,  2.22691e-05, -4.46723e-04,
          -5.52769e-04,  5.74451e-04, -1.97090e-03,  1.11542e-03, -1.72752e-04,
          -6.22300e-05, -1.91429e-03,  7.79176e-03,  3.01227e-03,  1.86331e-03,
           2.51917e-02, -8.64008e-03,  5.28091e-03, -1.36424e-02, -4.13666e-03,
           8.10342e-03,  4.59267e-03, -1.53397e-02, -3.11988e-02, -2.02702e-02,
          -2.35026e-02,  3.98544e-02,  2.41257e-02,  1.72835e-01, -3.42610e-01,
           9.53332e-02,  1.24770e-02,  1.07282e-01, -1.03539e-02, -6.84006e-03,
           1.12310e-02,  5.43809e-03,  9.32998e-04, -2.29631e-03,  6.29924e-03,
           2.02722e-02,  4.79790e-04,  2.01381e-03, -1.53268e-03,  1.21843e-02,
          -2.62547e-03, -2.50569e-03, -1.34518e-03,  1.06887e-03,  1.46076e-03,
           1.08261e-02, -6.80276e-03, -3.94907e-03,  1.71301e-03, -5.46163e-04,
           1.06000e-03,  1.53522e-03,  2.27589e-03,  6.37584e-03,  4.74560e-03,
          -2.85275e-03, -9.89594e-04,  5.79450e-03, -6.52117e-03, -3.98925e-03,
          -2.38117e-03,  2.45930e-03,  2.70455e-03,  8.32520e-03,  1.67776e-02,
           1.01020e-02,  8.65028e-03,  3.84294e-03,  2.39778e-03,  8.23488e-04,
          -2.73835e-03,  9.24478e-06, -1.62283e-02,  3.67017e-03, -9.10785e-03,
          -1.19134e-03, -1.74962e-02, -6.01155e-03, -2.90681e-03, -1.74662e-03,
           2.76031e-03,  2.85891e-03,  4.68437e-03,  3.84765e-03,  9.21422e-03
          };
   fIndices = {mf::eDiskB1, mf::eDiskB2, mf::eDiskB3,
               mf::eDiskPhase1, mf::eDiskPhase2, mf::eDiskPhase3,
               mf::eDiskPitch, mf::eToroidalBN, mf::eToroidalBS,
               mf::eToroidalR, mf::eToroidalR, mf::eToroidalZ,
               mf::ePoloidalB, mf::ePoloidalP, mf::ePoloidalR,
               mf::ePoloidalW, mf::ePoloidalZ, mf::eDiskH, mf::eDiskW,
               mf::eStriation, };
    break;
  }
  case mf::synCG: {
    fL = {
           1.15009e-01, -1.30481e-02,  1.95195e-01, -3.07713e-02,  6.27189e-02,
           1.17959e-01,  5.18078e+00,  9.43467e+00, -3.19961e-02,  6.38003e+00,
          -9.37592e-01,  9.54087e-01,  1.68774e+00,  2.08061e+00,  1.44460e+00,
           6.00371e-01,  2.70604e-01,  5.77064e-01,  1.88987e+00,  1.00233e+00,
           5.29764e-01,  3.45498e-02,  4.64672e-02,  1.32930e-02,  9.61937e-02,
           6.16804e-02,  2.25796e-02,  1.96286e-02,  1.84849e-02,  3.03808e-02,
          -2.08505e-02,  7.25179e-03,  5.49776e-03,  5.37055e-03,  1.98209e-03,
           1.13670e-01, -1.07700e-02, -2.71724e-02,  2.09620e-02, -8.70523e-03,
           7.58986e-04, -9.08804e-03, -4.82306e-03, -9.67292e-02,  2.57750e-02,
           1.16133e-03,  1.14416e-03,  3.83472e-04,  5.74181e-03, -6.08143e-03,
          -2.60633e-03,  1.77141e-02, -8.97820e-03,  1.50612e-03,  7.27791e-02,
           9.94724e-03,  6.39073e-03, -4.80629e-03,  6.21323e-03,  2.27623e-03,
          -5.80172e-03,  1.76800e-02, -3.96434e-03,  1.00174e-02,  9.57405e-02,
           1.26793e-01,  4.38218e-03, -7.84313e-02,  2.41477e-01, -1.26010e-01,
          -9.21734e-03,  1.89501e-02, -8.95399e-02, -6.52319e-01,  9.85619e-02,
           5.95953e-02,  2.34209e-01,  2.93301e-01,  4.13192e-03,  5.37509e-03,
           5.26493e-03, -2.67572e-03, -1.05118e-03,  5.01763e-03, -4.33482e-03,
           6.92714e-03, -1.59776e-03,  2.57235e-03,  1.46700e-03,  9.93326e-03,
           1.75198e-02, -2.02555e-03, -6.68863e-04,  4.05621e-03, -1.94302e-03,
          -3.67509e-03, -6.47640e-04,  4.03735e-03,  3.52458e-03,  8.51103e-03,
           5.83884e-03, -6.12545e-03, -1.50818e-03, -3.66162e-02,  8.53024e-02,
          -2.55743e-03, -3.44464e-03,  2.39205e-03, -5.60010e-04, -2.62936e-03,
          -2.36148e-03,  4.56319e-03, -2.65685e-04, -2.16294e-03, -6.86292e-04,
           7.63793e-04, -7.68778e-03, -2.51403e-02,  2.23074e-02,  3.22221e-02,
          -1.11518e-04, -5.81921e-04, -9.84197e-04,  4.07938e-04,  4.94507e-04,
          -5.78238e-04, -5.59666e-05, -1.19939e-03,  1.43077e-03,  7.47465e-04,
          -9.83111e-04, -3.71364e-04,  8.47564e-03,  1.36729e-03, -2.20635e-03,
           1.95056e-02,  8.97895e-03, -1.78754e-03,  5.97536e-04,  4.76716e-03,
           6.72364e-03,  3.32842e-03, -1.10944e-02, -1.46857e-02, -1.76549e-02,
          -1.55599e-02,  2.61230e-02,  9.80107e-03,  1.06127e-01, -1.95382e-01,
           4.94816e-02, -2.04320e-03,  6.72035e-02,  4.11144e-03,  4.25949e-03,
          -3.95771e-03,  2.82798e-03,  6.51540e-04,  3.21382e-04,  1.59452e-03,
           1.12796e-02, -6.09444e-04,  4.62697e-05,  1.25347e-04,  6.45032e-03,
          -1.48039e-03, -1.25567e-03, -1.23303e-03,  5.85207e-04,  1.55469e-03,
           8.54946e-03,  2.53992e-03,  3.23958e-03,  2.45908e-04, -8.43205e-04,
           7.49560e-05,  2.01511e-03,  1.06905e-03,  3.81015e-03,  2.15383e-03,
           1.29658e-03,  1.30953e-03,  4.56248e-04, -5.72232e-03, -3.03514e-03,
          -1.80565e-03,  2.35896e-03,  3.18910e-03,  5.66936e-03,  1.38641e-02,
          -7.53311e-03, -1.13276e-02, -1.15319e-02,  7.77352e-03,  1.91796e-03,
          -8.35431e-03,  7.27292e-03, -1.42522e-02,  3.21509e-03, -5.54570e-03,
          -1.81916e-03, -1.88990e-02, -6.17192e-03, -2.55830e-03, -2.15081e-03,
           2.93603e-03,  4.18999e-03,  4.19302e-03,  4.57685e-03,  8.82382e-03
          };
    fIndices = {mf::eDiskB1, mf::eDiskB2, mf::eDiskB3,
                mf::eDiskPhase1, mf::eDiskPhase2, mf::eDiskPhase3,
                mf::eDiskPitch, mf::eToroidalBN, mf::eToroidalBS,
                mf::eToroidalR, mf::eToroidalR, mf::eToroidalZ,
                mf::ePoloidalB, mf::ePoloidalP, mf::ePoloidalR,
                mf::ePoloidalW, mf::ePoloidalZ, mf::eDiskH, mf::eDiskW,
                mf::eStriation};
    break;
  }
  case mf::twistX: {
   fL = {
           1.72433e-01,  8.37026e-02,  2.90355e-01, -1.76817e-01,  8.54977e-02,
           1.67920e-01,  7.01813e+00,  6.69310e+00, -3.66782e-01,  6.07378e+00,
           8.35414e+00, -2.25688e+00, -2.87561e+00,  3.76860e+00,  2.79103e+00,
           2.60261e+00, -2.56160e+00, -8.65256e-01,  4.36172e+00,  1.45771e+00,
           1.21022e+00,  2.27081e-01, -2.37949e-02, -1.68642e-02,  3.31310e-01,
           1.69639e-01,  2.77627e-02,  6.19759e-02,  5.11973e-04,  1.85775e-03,
          -5.25589e-03, -1.42024e-03, -1.39823e-03,  3.55171e-03, -1.57129e-03,
           1.82781e-02,  9.45340e-04,  1.90707e-02, -8.36930e-03,  2.33953e-03,
          -6.36652e-03,  1.77902e-02,  1.76298e-02, -5.42652e-03,  9.35143e-02,
           4.38441e-04,  2.27361e-04,  3.90155e-03,  2.37003e-03, -2.52589e-04,
          -2.05597e-03,  9.42064e-03, -1.39712e-02,  9.98522e-03,  2.91920e-02,
           6.92194e-04, -1.26661e-04,  2.02580e-03, -3.39608e-03,  8.32836e-04,
           1.63346e-03,  7.51868e-03,  1.16391e-02,  7.91159e-03,  3.51380e-03,
           3.06259e-02,  8.05612e-04, -1.70310e-02,  1.04284e-02,  1.50687e-03,
           4.11253e-03, -1.16445e-02, -1.41870e-02,  2.13280e-02, -7.23358e-02,
           2.16370e-02,  2.91633e-03,  5.07134e-02, -8.92148e-03,  9.40096e-02,
           9.09545e-02, -4.44295e-02,  8.11464e-02, -2.96228e-02,  1.46224e-01,
          -5.03156e-01,  3.01533e-01, -1.13292e-01,  2.92832e-01,  4.00428e-01,
           7.32165e-01, -8.37863e-04,  2.17863e-02,  2.15051e-02,  1.56049e-02,
           4.55107e-03, -5.58089e-03,  1.83856e-02,  6.69798e-03,  3.63093e-03,
          -2.86103e-03, -6.24938e-03,  1.86983e-03,  4.15707e-03,  2.46163e-02,
          -2.53921e-03,  3.33047e-02, -3.15824e-02,  7.85857e-03, -3.04720e-03,
           1.19989e-02, -8.59346e-03, -1.29662e-02, -1.76641e-03, -5.37499e-03,
          -6.43128e-03,  9.63560e-03, -1.01702e-02,  2.77523e-02,  3.44296e-02,
          -6.28221e-04, -7.57042e-03,  1.50476e-02,  3.86451e-03,  3.08275e-03,
          -7.98971e-03,  1.69449e-03, -1.89786e-02, -7.28277e-03,  5.03776e-05,
           6.45150e-03,  8.86804e-03, -1.62960e-02, -2.19189e-03,  6.51199e-03,
           1.26219e-02};
   fIndices = {mf::eDiskB1, mf::eDiskB2, mf::eDiskB3,
               mf::eDiskPhase1, mf::eDiskPhase2, mf::eDiskPhase3,
               mf::eDiskPitch, mf::ePoloidalB, mf::ePoloidalP, mf::ePoloidalR,
               mf::ePoloidalW, mf::ePoloidalZ, mf::eTwistingTime,
               mf::eDiskH, mf::eDiskW, mf::eStriation};
   break;
  }
  case mf::nebCor: {
   fL = {
           1.86530e-01, -8.70506e-02,  2.56533e-01,  4.25910e-02,  7.29929e-02,
           1.90298e-01,  4.12779e+00, -5.58291e+00, -1.22614e-01,  4.86318e+00,
          -4.96171e-01, -7.66097e-01, -1.57074e+00,  2.29873e+00,  1.33702e+00,
           6.49478e-01,  2.20572e-01, -5.00566e-01,  2.05293e+00,  9.53721e-01,
           5.39390e-01,  5.69707e-02, -2.41106e-02, -6.31647e-03,  1.10339e-01,
           6.09710e-02,  2.00419e-02,  2.26381e-02,  7.54429e-02, -3.77088e-02,
           1.87065e-01,  9.01907e-02,  3.07299e-02, -6.88311e-02,  7.56767e-02,
           3.25258e-01, -4.83500e-02,  4.43404e-02, -1.90019e-01, -1.01222e-01,
          -9.08894e-04,  5.51363e-02, -8.66761e-02, -3.02953e-01,  7.89309e-02,
          -8.35863e-03,  2.29183e-02,  1.90886e-02,  3.57332e-02, -1.08960e-02,
          -1.85254e-02,  3.60107e-02, -4.57629e-02,  1.31926e-02,  1.53250e-01,
          -2.22866e-03,  5.36636e-02,  7.55244e-02,  6.71207e-02,  1.06902e-02,
          -3.72101e-02,  4.95671e-02, -2.62844e-02,  1.68957e-02,  1.80056e-01,
           3.37861e-01, -4.43864e-02,  5.28021e-02, -2.29802e-01, -1.26101e-01,
           1.77845e-03,  7.84494e-02, -1.01032e-01, -4.44026e-01,  8.09809e-02,
          -4.25204e-02,  1.52661e-01,  1.16069e-01,  3.45397e-04, -3.53305e-05,
           2.99545e-03,  2.37063e-03, -9.46282e-04,  9.56211e-04, -2.05276e-04,
           5.15921e-04, -1.12401e-03, -5.08752e-04,  1.91936e-03,  2.00999e-04,
           3.61846e-02, -2.38041e-03,  1.93342e-03, -5.16813e-03, -2.37963e-03,
          -1.41246e-03, -1.44949e-03,  2.30447e-03,  1.79737e-03,  7.83999e-03,
           5.32212e-03, -2.92653e-03, -2.54312e-03, -4.66481e-02,  8.50684e-02,
          -3.29592e-03,  3.76501e-03, -8.62663e-03, -1.65197e-03, -4.21257e-03,
          -1.26909e-04,  2.66390e-03,  2.50070e-03, -2.05346e-03,  1.31931e-03,
           2.73650e-04, -5.64819e-03, -3.61579e-02,  3.20716e-02,  4.22619e-02,
           1.84009e-05,  7.53342e-04, -9.65512e-04, -9.26097e-04, -3.26285e-04,
          -1.02725e-03,  6.62005e-04, -1.34038e-03,  1.21181e-03,  1.88497e-03,
          -5.96531e-05, -1.04151e-03,  1.33320e-02,  7.67910e-03,  5.05394e-03,
           2.86093e-02,  1.04777e-02,  1.20763e-03,  2.24060e-03,  7.77451e-03,
           2.21185e-03,  1.13711e-02, -1.33506e-02, -2.03151e-02, -3.80157e-02,
          -3.28525e-02,  3.18074e-02,  1.87635e-02,  2.57074e-01, -4.06170e-01,
           1.14853e-01,  1.51536e-03,  1.15373e-01,  8.33404e-03, -3.61327e-03,
           1.16729e-02,  6.20086e-03,  1.58580e-03, -4.19226e-03,  6.94075e-03,
           1.23202e-02,  1.00829e-03, -1.53942e-03, -1.94712e-03,  1.23490e-02,
           4.62033e-04, -7.59390e-04, -5.72095e-04, -1.87214e-04,  1.25336e-04,
           9.43956e-03,  7.90602e-03, -4.75612e-03,  3.96693e-04, -1.67792e-03,
           1.51969e-03,  2.94090e-03,  2.17418e-03,  6.19018e-03,  3.02440e-03,
          -2.94045e-03, -1.10547e-03,  1.34260e-02, -8.60215e-04, -9.56234e-04,
          -4.50606e-04,  4.71144e-04,  1.46171e-04,  4.18730e-03,  1.60643e-02
          };
   fIndices = {mf::eDiskB1, mf::eDiskB2, mf::eDiskB3,
               mf::eDiskPhase1, mf::eDiskPhase2, mf::eDiskPhase3,
               mf::eDiskPitch, mf::eToroidalBN, mf::eToroidalBS,
               mf::eToroidalR, mf::eToroidalR, mf::eToroidalZ,
               mf::ePoloidalB, mf::ePoloidalP, mf::ePoloidalR,
               mf::ePoloidalW, mf::ePoloidalZ, mf::eDiskH, mf::eDiskW};
   break;
  }
  default: {
    throw std::runtime_error("unknown field model");
    break;
  }
  }
  fV = utl::VfromL(fL);
}

void
ParameterCovariance::PrintCorrelationMatrix()
  const
{
  using namespace std;
  for (unsigned int iPar = 0; iPar < fV.size(); ++iPar) {
    for (unsigned int jPar = 0; jPar < fV.size(); ++jPar) {
      const double denom = sqrt(fV[jPar][jPar]*fV[iPar][iPar]);
      const double rho = fV[iPar][jPar] / denom;
      cout << setw(4) << round(rho*100);
    }
    cout << endl;
  }
}
